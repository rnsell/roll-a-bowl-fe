# ğŸš€ Quick Reference Guide

Fast lookup for common tasks and commands.

---

## ğŸ¯ Most Common Tasks

### I want to... add a new GraphQL query

1. **Define the query** in `lib/graphql/operations.ts`:

   ```typescript
   export const GET_USERS = gql`
     query GetUsers($page: Int) {
       users(page: $page) {
         items {
           id
           email
           name
         }
       }
     }
   `;
   ```

2. **Generate types**:

   ```bash
   npm run generate
   ```

3. **Use in component** (with Suspense):

   ```typescript
   import { useSuspenseQuery } from "@apollo/client";
   import { GetUsersDocument } from "@/lib/graphql/generated";

   function UsersList() {
     const { data } = useSuspenseQuery(GetUsersDocument);
     return (
       <div>
         {data.users.items.map((u) => (
           <div>{u.name}</div>
         ))}
       </div>
     );
   }
   ```

### I want to... fetch data in a component

**Option 1: Direct apolloClient.query()** (Current approach)

```typescript
"use client";
import { useEffect, useState } from "react";
import { apolloClient } from "@/lib/graphql/client";
import { GetUsersDocument } from "@/lib/graphql/generated";

function MyComponent() {
  const [data, setData] = useState(null);

  useEffect(() => {
    apolloClient.query({ query: GetUsersDocument }).then((res) => {
      setData(res.data);
    });
  }, []);

  return <div>{data && <pre>{JSON.stringify(data)}</pre>}</div>;
}
```

**Option 2: useSuspenseQuery** (With Suspense)

```typescript
"use client";
import { Suspense } from "react";
import { useSuspenseQuery } from "@apollo/client";
import { GetUsersDocument } from "@/lib/graphql/generated";

function Users() {
  const { data } = useSuspenseQuery(GetUsersDocument);
  return <div>{data.users.items.length} users</div>;
}

export default function Page() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <Users />
    </Suspense>
  );
}
```

### I want to... handle authentication

**Login:**

```typescript
import { useAuth } from "@/hooks/useAuth";

function LoginForm() {
  const { login, isLoading, error } = useAuth();

  const handleSubmit = async (email: string, password: string) => {
    await login(email, password);
    // Redirects to dashboard on success
  };
}
```

**Check if logged in:**

```typescript
import { useAuth } from "@/hooks/useAuth";

function MyComponent() {
  const { user, isAuthenticated } = useAuth();

  if (!isAuthenticated) return <div>Please log in</div>;
  return <div>Welcome, {user.email}</div>;
}
```

**Logout:**

```typescript
import { useAuth } from "@/hooks/useAuth";

function LogoutButton() {
  const { logout } = useAuth();
  return <button onClick={logout}>Sign Out</button>;
}
```

### I want to... protect a route

Use middleware - it's already configured! Routes like `/dashboard` automatically redirect to `/auth/login` if not authenticated.

To add protection to a new route:

1. Create the route folder
2. Middleware will handle redirection automatically
3. Protected routes are in `middleware.ts` config

### I want to... add environment variables

1. **Add to `.env.local`**:

   ```bash
   MY_NEW_VAR=value
   ```

2. **Access in code**:

   ```typescript
   import { config } from "@/lib/config";
   const value = config.myNewVar;
   ```

3. **For public vars**, prefix with `NEXT_PUBLIC_`:
   ```bash
   NEXT_PUBLIC_MY_VAR=value
   ```

---

## ğŸ”§ Useful Commands

```bash
# Start development server
npm run dev

# Generate GraphQL types
npm run generate

# Watch GraphQL changes
npm run generate:watch

# Build for production
npm run build

# Start production server
npm start

# Check linting issues
npm run lint

# Format code
npm run format
```

---

## ğŸ“ File Structure

```
/Users/robertsell/Code/tenant-fe/
â”œâ”€â”€ app/                          # Next.js App Router
â”‚   â”œâ”€â”€ api/                       # API routes
â”‚   â”‚   â”œâ”€â”€ auth/                  # Authentication endpoints
â”‚   â”‚   â””â”€â”€ graphql/               # GraphQL proxy
â”‚   â”œâ”€â”€ auth/                      # Auth pages
â”‚   â”œâ”€â”€ dashboard/                 # Protected pages
â”‚   â””â”€â”€ page.tsx                   # Home page
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ config/                    # Configuration
â”‚   â”œâ”€â”€ graphql/                   # GraphQL client & setup
â”‚   â”‚   â””â”€â”€ generated/             # Generated by CodeGen
â”‚   â”œâ”€â”€ backend/                   # Backend clients
â”‚   â””â”€â”€ session/                   # Session management
â”œâ”€â”€ hooks/                         # React hooks
â”‚   â””â”€â”€ useAuth.tsx                # Authentication hook
â”œâ”€â”€ docs/                          # Documentation
â””â”€â”€ middleware.ts                  # Next.js middleware
```

---

## ğŸ”‘ Environment Variables

Essential vars:

```bash
# API
API_KEY=your_api_key
NEXT_PUBLIC_API_BASE_URL=http://localhost:3000

# GraphQL
GRAPHQL_SCHEMA_URL=http://localhost:3000/graphql

# Session
SESSION_COOKIE_NAME=session
SESSION_SECRET=your_secret
SESSION_MAX_AGE=86400

# Storage
SESSION_STORAGE=memory
```

---

## ğŸ§ª Testing URLs

```
Home:           http://localhost:3001
Login:          http://localhost:3001/auth/login
Dashboard:      http://localhost:3001/dashboard
Signup:         http://localhost:3001/auth/signup
Password Reset: http://localhost:3001/auth/forgot-password
```

---

## ğŸ“Š Architecture at a Glance

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         React/Next.js Client            â”‚
â”‚  (useAuth hook, Apollo Client queries)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Next.js API Routes (BFF)           â”‚
â”‚  /api/auth/* (Login, Logout, etc.)      â”‚
â”‚  /api/graphql (GraphQL Proxy)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Backend API                        â”‚
â”‚  REST endpoints (auth)                  â”‚
â”‚  GraphQL endpoint (data)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Authentication Flow

```
1. User enters credentials at /auth/login
   â†“
2. POST /api/auth/login (frontend â†’ BFF)
   â†“
3. BFF calls backend REST API with credentials
   â†“
4. Backend returns user data + userToken (JWT)
   â†“
5. BFF creates session with JWT, sets httpOnly cookie
   â†“
6. Browser gets httpOnly cookie (can't be accessed by JS)
   â†“
7. Future requests include cookie automatically
   â†“
8. BFF uses JWT from session to call backend GraphQL
   â†“
9. Frontend never sees JWT (stays server-side!)
```

---

## ğŸš¨ Common Issues & Fixes

### "Module not found: '@apollo/client'"

```bash
npm install @apollo/client graphql
```

### Dev server won't start

```bash
pkill -f "next dev"
npm run dev
```

### Generated types not updated

```bash
npm run generate
# Or watch mode:
npm run generate:watch
```

### Apollo Client cache issues

Clear browser localStorage and restart dev server:

```bash
# In browser dev tools
localStorage.clear()
# Then restart
```

### Session lost after refresh

- Check if `.env.local` has SESSION_SECRET
- Check if SESSION_STORAGE is "memory"
- For production, use Redis or database

---

## ğŸ“– Related Documentation

- **Full authentication flow**: `docs/AUTHENTICATION_ARCHITECTURE.md`
- **GraphQL setup**: `docs/GRAPHQL_SETUP_COMPLETE.md`
- **Data fetching patterns**: `docs/APOLLO_SUSPENSE_PATTERNS.md`
- **All tasks**: `docs/tasks.md`

---

## ğŸ†˜ Need Help?

1. Check the relevant doc in `docs/` folder
2. Look at example implementations in `app/`
3. Check code comments in `lib/`
4. Read error messages carefully!

---

**Last Updated**: November 8, 2025
